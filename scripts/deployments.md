# thales-markets/contracts/scripts/

Deployment scripts instructions for Thales contracts.

## Process Overview

### 0. Deploying Thales token contract

```bash
npx hardhat run --network ropsten scripts/thales/deploy_thales.js
```

This will create the THALES token and mint 100m into owner's wallet.

### 1. Deploying VestingEscrow contract

The first step is to run historical SNX stakers script with following command:

```bash
node scripts/snx-data/historical_snx_stakers.js
```

This script will generate JSON file - [`historical_snx.json`](./snx-data/historical_snx.json), which will be the input for `VestingEscrow` deployment script - [`historical_token_distribution.js`](./deployRetroLinearUnlock/historical_token_distribution.js):

```bash
npx hardhat run --network ropsten scripts/deployRetroLinearUnlock/historical_token_distribution.js
```

Deployment scripts will also update [`deployments.json`](./deployments.json) file with addresses of deployed contracts.

Sanity check files:

- Distribution before floor and investors scripts/snx-data/sorted_historical_stakers.json
- Final distribution with floor and investors scripts/snx-data/sorted_historical_stakers_after_floor.json

About 24m tokens should be in this contract.

### 2. Deploying Airdrop contract

The file [`historical_snx.json`](./snx-data/historical_snx.json) is also input for `Airdrop` contract deployment script, run with following command:

```bash
npx hardhat run --network ropsten scripts/airdrop/deploy_airdrop.js
```

Deployment script will generate [`airdrop-hashes.json`](./airdrop/airdrop-hashes.json).  
This file needs to be added in the dapp manually.

### 3. Deploying OngoingAirdrop and EscrowThales contract

Input for the deployment script is [`ongoing_distribution.json`](./snx-data/ongoing_distribution.json) which is generated by [`ongoing_distribution.js`](./snx-data/ongoing_distribution.js):

```bash
node scripts/snx-data/ongoing_distribution.js start_date end_date
```

Arguments (`start_date`, `end_date`) are in format `yyyy-mm-dd` and also represent one week period (ideally Wednesday 00:00:00 to Wednesday 23:59:59 - to include the last two Synthetix `FeePeriodClosed` events).

Run initial deployment script with following command:

```bash
npx hardhat run --network ropsten scripts/deployOngoingRewards/deployOngoingAirdrop.js
```

The script will also deploy the `EscrowThales` contract and generate file [`ongoing-airdrop-hashes-period-1.json`](./deployOngoingRewards/ongoing-airdrop-hashes-period-1.json) - which will also be the input for OngoingAirdrop maintenance script.

### 4. OngoingAirdrop maintenance

Before running the script below check if rewards distribution between L1 and L2 needs to be tweaked depending on the number of stakers on L1 and L2.
First, run [`ongoing_distribution.js`](./snx-data/ongoing_distribution.js) for the appropriate period (can be run before the THALES staking period ends, but after SNX weekly period):

```bash
node scripts/snx-data/ongoing_distribution.js start_date end_date
```

example:
```bash
node scripts/snx-data/ongoing_distribution.js 2021-11-03 2021-11-10
```

Script takes 5 minutes.
Inputs for OngoingAirdrop maintenance script are [`ongoing_distribution.json`](./snx-data/ongoing_distribution.json) - generated by the previous command and `ongoing-airdrop-hashes-period-PERIOD.json` - generated in the last maintenance cycle.


The following steps have to be executed after the staking contract period can be closed.
Update: Due to security reasons the owner is now a multisig so running a script is not possible as before, rather the steps are (HAS TO BE DONE IN THIS ORDER):  
* Gnosis Pause ongoing airdrop https://etherscan.io/address/0xDAaB884D083FE5c38b4679ae194c52f176Bd8783
* Gnosis close staking period https://etherscan.io/address/0x883D651429B0829BC045A94F288f3b514021B8C1
* Pause staking contract https://etherscan.io/address/0x883D651429B0829BC045A94F288f3b514021B8C1
* Run the script ```
                 npx hardhat run --network mainnet scripts/deployOngoingRewards/ongoingAirdrop.js
                 ```
                 Script takes 5 minutes.
* Push the new hashes file
* Gnosis set the new root 
* Gnosis unpause staking and ongoing airdrop

Sanity check:
* Make sure unclaimed rewards are carried over
* Make sure all addresses are lower case

The script will generate `ongoing-airdrop-hashes-period-(PERIOD+1).json`, input for the next maintenance cycle.

### 5. Deploying StakingThales contract

Run StakingThales deployment script with the following command:

```bash
npx hardhat run --network ropsten scripts/deployStaking/deploy.js
```

The script enables the staking process from the beginning (runs `startStaking()` on deployment).
